-- setup-admin.sql
-- Supabase ç®¡ç†å‘˜ç”¨æˆ·è®¾ç½®è„šæœ¬

-- 1. åˆ›å»ºç•™è¨€è¡¨
CREATE TABLE IF NOT EXISTS guestbook (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  author TEXT NOT NULL,
  email TEXT,
  content TEXT NOT NULL,
  mood TEXT DEFAULT 'ğŸ˜Š',
  likes INTEGER DEFAULT 0,
  device TEXT,
  parent_id BIGINT REFERENCES guestbook(id) ON DELETE CASCADE,
  is_admin BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

-- 2. åˆ›å»ºç®¡ç†å‘˜è¡¨
CREATE TABLE IF NOT EXISTS admins (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  email TEXT NOT NULL UNIQUE,
  role TEXT DEFAULT 'moderator',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

-- 3. å¯ç”¨è¡Œçº§å®‰å…¨ï¼ˆRLSï¼‰
ALTER TABLE guestbook ENABLE ROW LEVEL SECURITY;
ALTER TABLE admins ENABLE ROW LEVEL SECURITY;

-- 4. åˆ é™¤ç°æœ‰ç­–ç•¥ï¼ˆé¿å…é‡å¤ï¼‰
DROP POLICY IF EXISTS "ä»»ä½•äººéƒ½å¯ä»¥æŸ¥çœ‹ç•™è¨€" ON guestbook;
DROP POLICY IF EXISTS "ä»»ä½•äººéƒ½å¯ä»¥å‘è¡¨ç•™è¨€" ON guestbook;
DROP POLICY IF EXISTS "åªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ é™¤ç•™è¨€" ON guestbook;
DROP POLICY IF EXISTS "åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ›´æ–°ç•™è¨€" ON guestbook;
DROP POLICY IF EXISTS "åªæœ‰ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹ç®¡ç†å‘˜è¡¨" ON admins;

-- 5. åˆ›å»ºæ–°ç­–ç•¥
-- ä»»ä½•äººéƒ½å¯ä»¥æŸ¥çœ‹ç•™è¨€
CREATE POLICY "ä»»ä½•äººéƒ½å¯ä»¥æŸ¥çœ‹ç•™è¨€" ON guestbook
  FOR SELECT USING (true);

-- ä»»ä½•äººéƒ½å¯ä»¥å‘è¡¨ç•™è¨€
CREATE POLICY "ä»»ä½•äººéƒ½å¯ä»¥å‘è¡¨ç•™è¨€" ON guestbook
  FOR INSERT WITH CHECK (true);

-- åªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ é™¤ç•™è¨€
CREATE POLICY "åªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ é™¤ç•™è¨€" ON guestbook
  FOR DELETE USING (
    EXISTS (
      SELECT 1 FROM admins 
      WHERE admins.id = auth.uid()
    )
  );

-- åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ›´æ–°ç•™è¨€ï¼ˆå¦‚ç‚¹èµï¼‰
CREATE POLICY "åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ›´æ–°ç•™è¨€" ON guestbook
  FOR UPDATE USING (
    EXISTS (
      SELECT 1 FROM admins 
      WHERE admins.id = auth.uid()
    )
  ) WITH CHECK (true);

-- åªæœ‰ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹ç®¡ç†å‘˜è¡¨
CREATE POLICY "åªæœ‰ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹ç®¡ç†å‘˜è¡¨" ON admins
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM admins a
      WHERE a.id = auth.uid()
    )
  );

-- 6. åˆ›å»ºç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
CREATE INDEX IF NOT EXISTS idx_guestbook_created_at ON guestbook(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_guestbook_parent_id ON guestbook(parent_id);
CREATE INDEX IF NOT EXISTS idx_admins_email ON admins(email);
CREATE INDEX IF NOT EXISTS idx_guestbook_is_admin ON guestbook(is_admin);

-- 7. åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·å‡½æ•°
CREATE OR REPLACE FUNCTION setup_admin_user(
  admin_email TEXT,
  admin_name TEXT DEFAULT 'ç®¡ç†å‘˜',
  admin_role TEXT DEFAULT 'admin'
)
RETURNS TABLE (user_id UUID, user_email TEXT, setup_result TEXT) 
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  admin_uuid UUID;
BEGIN
  -- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
  SELECT id INTO admin_uuid 
  FROM auth.users 
  WHERE email = admin_email;
  
  -- å¦‚æœç”¨æˆ·ä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯
  IF admin_uuid IS NULL THEN
    RETURN QUERY SELECT NULL::UUID, admin_email, 'ç”¨æˆ·ä¸å­˜åœ¨ï¼Œè¯·å…ˆåœ¨Supabase Authä¸­åˆ›å»ºç”¨æˆ·';
    RETURN;
  END IF;
  
  -- æ’å…¥æˆ–æ›´æ–°adminsè¡¨
  INSERT INTO admins (id, name, email, role)
  VALUES (admin_uuid, admin_name, admin_email, admin_role)
  ON CONFLICT (id) DO UPDATE 
  SET name = EXCLUDED.name, 
      email = EXCLUDED.email,
      role = EXCLUDED.role,
      updated_at = NOW();
  
  -- è¿”å›ç»“æœ
  RETURN QUERY SELECT admin_uuid, admin_email, 'ç®¡ç†å‘˜è®¾ç½®æˆåŠŸ';
END;
$$;

-- 8. åˆ›å»ºç®¡ç†å‘˜æ“ä½œæ—¥å¿—è¡¨ï¼ˆå¯é€‰ï¼‰
CREATE TABLE IF NOT EXISTS admin_logs (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  admin_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  action TEXT NOT NULL,
  table_name TEXT,
  record_id TEXT,
  details JSONB,
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

-- 9. åˆ›å»ºæ“ä½œæ—¥å¿—å‡½æ•°
CREATE OR REPLACE FUNCTION log_admin_action()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO admin_logs (admin_id, action, table_name, record_id, details)
  VALUES (
    auth.uid(),
    TG_OP,
    TG_TABLE_NAME,
    CASE 
      WHEN TG_OP = 'DELETE' THEN OLD.id::TEXT
      ELSE NEW.id::TEXT
    END,
    CASE
      WHEN TG_OP = 'DELETE' THEN jsonb_build_object(
        'old_data', to_jsonb(OLD),
        'deleted_at', NOW()
      )
      WHEN TG_OP = 'INSERT' THEN jsonb_build_object(
        'new_data', to_jsonb(NEW)
      )
      WHEN TG_OP = 'UPDATE' THEN jsonb_build_object(
        'old_data', to_jsonb(OLD),
        'new_data', to_jsonb(NEW),
        'updated_at', NOW()
      )
    END
  );
  RETURN NULL;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 10. ä¸ºguestbookè¡¨åˆ›å»ºæ—¥å¿—è§¦å‘å™¨
DROP TRIGGER IF EXISTS log_guestbook_admin_actions ON guestbook;
CREATE TRIGGER log_guestbook_admin_actions
AFTER INSERT OR UPDATE OR DELETE ON guestbook
FOR EACH ROW
EXECUTE FUNCTION log_admin_action();

-- 11. ä½¿ç”¨è¯´æ˜æ³¨é‡Š
COMMENT ON TABLE guestbook IS 'ç•™è¨€è¡¨ï¼Œå­˜å‚¨ç”¨æˆ·ç•™è¨€ä¿¡æ¯';
COMMENT ON TABLE admins IS 'ç®¡ç†å‘˜è¡¨ï¼Œå­˜å‚¨ç®¡ç†å‘˜ç”¨æˆ·ä¿¡æ¯';
COMMENT ON TABLE admin_logs IS 'ç®¡ç†å‘˜æ“ä½œæ—¥å¿—è¡¨ï¼Œè®°å½•æ‰€æœ‰ç®¡ç†å‘˜æ“ä½œ';
COMMENT ON FUNCTION setup_admin_user IS 'è®¾ç½®ç®¡ç†å‘˜ç”¨æˆ·å‡½æ•°ï¼Œå‚æ•°ï¼šadmin_email(é‚®ç®±), admin_name(å§“å), admin_role(è§’è‰²)';

-- 12. ç¤ºä¾‹ï¼šè®¾ç½®ç®¡ç†å‘˜ç”¨æˆ·
-- æ³¨æ„ï¼šéœ€è¦å…ˆåœ¨Supabase Authä¸­åˆ›å»ºç”¨æˆ·ï¼Œç„¶åè¿è¡Œä»¥ä¸‹æŸ¥è¯¢ï¼ˆå–æ¶ˆæ³¨é‡Šå¹¶æ›¿æ¢é‚®ç®±ï¼‰
-- SELECT * FROM setup_admin_user('admin@yourdomain.com', 'ç®¡ç†å‘˜', 'admin');

-- 13. æŸ¥çœ‹å½“å‰ç­–ç•¥
SELECT 
  schemaname,
  tablename,
  policyname,
  permissive,
  roles,
  cmd,
  qual
FROM pg_policies 
WHERE schemaname = 'public' 
AND tablename IN ('guestbook', 'admins')
ORDER BY tablename, policyname;